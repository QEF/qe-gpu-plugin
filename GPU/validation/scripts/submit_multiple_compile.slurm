#!/bin/bash

# Copyright (C) 2001-2006 Quantum ESPRESSO group
# This file is distributed under the terms of the
# GNU General Public License. See the file `License'
# in the root directory of the present distribution,
# or http://www.gnu.org/copyleft/gpl.txt .
#
# Author: Filippo Spiga (spiga _dot_ filippo _at_ gmail _dot_ com)
# Date: August 17, 2013
# Version: 1.0

# ** THIS SCRIPT IS JUST AN EXAMPLE, YOU NEED TO CUSTOMIZE IT **
# ** BASED ON YOUR HPC SYSTEM. I AM NOT RESPONSIBLE OF ANY    **
# ** DAMAGE GENERATED BY THIS SCRIPT -- FILIPPO               **

# General variables
TMPDIR='/tmp/'
TOPDIR=`echo ${HOME}`
PWDDIR=`pwd`

# Does CUDA exists -- ?
if [ -z "${CUDA_HOME}" ]; then
   CUDA_HOME=/usr/local/cuda
fi;

# Necessary to know QEVERSION
if [ -n "$1" ]; then
  . $1
else
  . compile_default.list
fi

# doublecheck this!
if [ "$2" ]; then
  FINALDIR=${TOPDIR}/exes-${QEVERSION}-`date "+%Y%m%d"`.$2
else
  FINALDIR=${TOPDIR}/exes-${QEVERSION}-`date "+%Y%m%d"`
fi;

# Necessary to fill properly FINALDIR -- ?
if [ "$1" ]; then
  . $1
else
  . compile_default.list
fi;

mkdir -p ${FINALDIR}

# Compress before copy
cd ${QEDIRPATH}
tar zcf ${TOPDIR}/espresso-build.tar.gz --exclude="*.svn" ${QEDIRNAME}
cd -

for (( i=1; i <= $makescript_lenght; i++ ))
do
    COMPILEDIR=${TMPDIR}tmp-espresso.`date "+%Y%m%d%H%M%S"`.${i}
    FILE=`pwd`/QE-COMPILE-${i}.slurm
    SCRIPT=$(cat <<EOF
#!/bin/bash
#SBATCH --job-name=QE-COMPILE-${i}
#SBATCH --error=QE-COMPILE-${i}.%J.err 
#SBATCH --output=QE-COMPILE-${i}.%J.out
#SBATCH --ntasks=1
mkdir -p ${COMPILEDIR}
export CUDA_HOME=${CUDA_HOME}
cd ${COMPILEDIR}
cp ${TOPDIR}/espresso-build.tar.gz .
tar zxf espresso-build.tar.gz
cd espresso 
EOF
)
  echo "${SCRIPT}" > ${FILE}
  echo "${makescript[$i]}" >> ${FILE}
  #sbatch ${FILE}
  output=`sbatch ${FILE}`
  echo $output

  #not yet implemented
  #$output = `sbatch $scriptFile`;
  # something = echo $output | grep -oE "[[:digit:]]{1,}" 
done

# Nice feature to add: cleaner job that remove temporary files under /tmp ONLY when other jobs are finish
#sbatch cleaner.slurm 
