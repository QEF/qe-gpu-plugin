#===================================
# Third-part CUDA-enabled libraries
#===================================
#
include ../../make.sys

#
# MAIN target
#
all:
ifdef NVCC
	$(MAKE) libOpenBLAS
	$(MAKE) libphiGEMM
	$(MAKE) libMAGMA
endif

# OpenBLAS
libOpenBLAS:
ifeq ($(OPENBLAS_ENABLED),1) 
	if test ! -d ../../OpenBLAS ; then \
	( gzip -dc ../archive/OpenBLAS-v0.2.5.tar.gz | \
		(cd ../../; tar -xvf ./GPU/archive/OpenBLAS-v0.2.5.tar.gz )); fi
	cd ../../OpenBLAS; make CC=$(CC) FC=$(F77) LIBNAMESUFFIX=qe libs;
endif
	
# phiGEMM
libphiGEMM:
ifeq ($(PHIGEMM_ENABLED),1) 
	if test ! -d ../../phiGEMM ; then \
	( gzip -dc ../archive/phiGEMM-v2.0.0rc2.tar.gz | \
		(cd ../../; tar -xvf ./GPU/archive/phiGEMM-v2.0.0rc2.tar.gz )); fi
	cp make_phiGEMM.inc ../../phiGEMM/make.inc;
	cd ../../phiGEMM; $(MAKE) phigemm;
endif

# MAGMA (+ CBLAS if necessary)
libMAGMA:
ifeq ($(CBLAS_ENABLED),1) 
	if test ! -d ../../CBLAS ; then \
	( gzip -dc ../archive/cblas.tar.gz | (cd ../../; tar -xvf ./GPU/archive/cblas.tar.gz )); fi
	cp make_cblas.inc ../../CBLAS/Makefile.in;
	cd ../../CBLAS; $(MAKE) alllib;
endif
ifeq ($(MAGMA_ENABLED),1) 
	if test ! -d ../../magma ; then \
	( gzip -dc ../archive/magma-1.3.0.tar.gz | \
		(cd ../../; tar -xvf ./GPU/archive/magma-1.3.0.tar.gz; )); fi
	cp make_magma.inc ../../magma/make.inc;
	cd ../../magma; $(MAKE) lib;
endif

###################################
# cleaning
###################################
# each lib independently

libOpenBLAS_clean:
	if test -d ../../OpenBLAS; then (cd ../../OpenBLAS; $(MAKE) clean); fi
libOpenBLAS_veryclean:
	if test -d ../../OpenBLAS; then (rm -R -f ../../OpenBLAS); fi
libphiGEMM_clean:
	if test -d ../../phiGEMM; then (cd ../../phiGEMM; $(MAKE) clean); fi
libphiGEMM_veryclean:
	if test -d ../../phiGEMM; then (rm -R -f ../../phiGEMM); fi
	rm -f make_phiGEMM.inc
libMAGMA_clean:
	if test -d ../../CBLAS; then (cd ../../CBLAS; $(MAKE) clean); fi
	if test -d ../../magma; then (cd ../../magma; $(MAKE) clean); fi
libMAGMA_veryclean:
	if test -d ../../CBLAS; then (rm -R -f ../../CBLAS); fi
	if test -d ../../magma; then (rm -R -f ../../magma); fi
	rm -f make_cblas.inc
	rm -f make_magma.inc

# general cleaning
clean: libOpenBLAS_clean libphiGEMM_clean libMAGMA_clean
veryclean: libOpenBLAS_veryclean libphiGEMM_veryclean libMAGMA_veryclean
